<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pengaturan Profil Mahasiswa - SIM-KIP</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="sidebar" id="mahasiswaSidebar">
        <h3>SIM - KIP</h3>
        <a href="dashboard-mahasiswa.html">Dashboard Saya</a>
        <a href="ajukan-perubahan-data.html">Ajukan Perubahan Data</a>
        <a href="profile-settings-mahasiswa.html" class="active">Pengaturan Profil</a>
        <a href="login.html" id="mahasiswaLogout">Logout</a>
    </div>

    <main class="main-content">
        <div class="header-main">
            <div class="header-left">
                <span class="user-role-label">Mahasiswa</span>
            </div>
            <div class="header-right">
                <div class="header-icons">
                    <i class="fas fa-search"></i>
                    <i class="fas fa-bell"></i>
                </div>
                <div class="user-profile-toggle" id="userProfileToggle">
                    <img src="https://via.placeholder.com/35" alt="User Avatar" />
                    <span id="loggedInUserName">Pengguna</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="dropdown-menu" id="userProfileDropdown">
                    <a href="profile-settings-mahasiswa.html" id="profileSettingsLinkDropdown">Pengaturan Profil</a>
                    <a href="help.html">Bantuan</a>
                    <a href="login.html">Logout</a>
                </div>
            </div>
        </div>

        <div class="page-header">
            <h2>Pengaturan Profil Mahasiswa</h2>
            <p>Kelola informasi akun dan kata sandi Anda.</p>
        </div>

        <div class="section-container">
            <div class="profile-card">
                <h3>Informasi Profil</h3>
                <div class="profile-info-display">
                    <div class="info-group">
                        <label>NIM:</label>
                        <span id="displayNIM"></span>
                    </div>
                    <div class="info-group">
                        <label>Nama Lengkap:</label>
                        <span id="displayNama"></span>
                    </div>
                    <div class="info-group">
                        <label>Jenis Kelamin:</label>
                        <span id="displayJenisKelamin"></span>
                    </div>
                    <div class="info-group">
                        <label>Tempat, Tanggal Lahir:</label>
                        <span id="displayTempatTglLahir"></span>
                    </div>
                    <div class="info-group">
                        <label>Agama:</label>
                        <span id="displayAgama"></span>
                    </div>
                    <div class="info-group">
                        <label>Nama Ibu Kandung:</label>
                        <span id="displayNamaIbu"></span>
                    </div>
                    <div class="info-group">
                        <label>No. HP Orang Tua:</label>
                        <span id="displayNoHpOrtu"></span>
                    </div>
                    <div class="info-group">
                        <label>Email Orang Tua:</label>
                        <span id="displayEmailOrtu"></span>
                    </div>
                </div>

                <form id="editProfileMahasiswaForm" class="profile-form" style="margin-top: 20px;">
                    <h4>Edit Informasi Profil</h4>
                    <div class="form-group-profile">
                        <label for="editNama">Nama Lengkap</label>
                        <input type="text" id="editNama" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="editJenisKelamin">Jenis Kelamin</label>
                        <select id="editJenisKelamin" required>
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div class="form-group-profile">
                        <label for="editTempatTglLahir">Tempat, Tanggal Lahir</label>
                        <input type="text" id="editTempatTglLahir" placeholder="Contoh: Jakarta, 01-01-2000" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="editAgama">Agama</label>
                        <input type="text" id="editAgama" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="editNamaIbu">Nama Ibu Kandung</label>
                        <input type="text" id="editNamaIbu" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="editNoHpOrtu">No. HP Orang Tua</label>
                        <input type="text" id="editNoHpOrtu" placeholder="Contoh: 081234567890" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="editEmailOrtu">Email Orang Tua</label>
                        <input type="email" id="editEmailOrtu" placeholder="Contoh: email@contoh.com">
                    </div>
                    <div>
                        <button type="submit" class="button-primary">Simpan Perubahan</button>
                    </div>
                    <div class="message" id="profileMahasiswaMessage"></div>
                </form>
            </div>

            <div class="profile-card">
                <h3>Ubah Password</h3>
                <form id="changePasswordMahasiswaForm" class="profile-form">
                    <div class="form-group-profile">
                        <label for="currentPasswordMahasiswa">Password Saat Ini</label>
                        <input type="password" id="currentPasswordMahasiswa" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="newPasswordMahasiswa">Password Baru</label>
                        <input type="password" id="newPasswordMahasiswa" required>
                    </div>
                    <div class="form-group-profile">
                        <label for="confirmNewPasswordMahasiswa">Konfirmasi Password Baru</label>
                        <input type="password" id="confirmNewPasswordMahasiswa" required>
                    </div>
                    <button type="submit" class="button-primary">Ubah Password</button>
                    <div class="message" id="passwordMahasiswaMessage"></div>
                </form>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            checkUserRole(['mahasiswa']); // Hanya mahasiswa yang bisa mengakses halaman ini

            const loggedInNIM = localStorage.getItem('loggedInNIM');
            if (loggedInNIM) {
                const mahasiswa = mahasiswaData.find(m => m.nim === loggedInNIM);

                if (mahasiswa) {
                    // Display current profile information
                    document.getElementById('displayNIM').textContent = mahasiswa.nim;
                    document.getElementById('displayNama').textContent = mahasiswa.nama;
                    document.getElementById('displayJenisKelamin').textContent = mahasiswa.jenis_kelamin;
                    document.getElementById('displayTempatTglLahir').textContent = mahasiswa.tempat_tgl_lahir;
                    document.getElementById('displayAgama').textContent = mahasiswa.agama;
                    document.getElementById('displayNamaIbu').textContent = mahasiswa.nama_ibu;
                    document.getElementById('displayNoHpOrtu').textContent = mahasiswa.no_hp_ortu;
                    document.getElementById('displayEmailOrtu').textContent = mahasiswa.email_ortu;

                    // Populate edit form fields
                    document.getElementById('editNama').value = mahasiswa.nama;
                    document.getElementById('editJenisKelamin').value = mahasiswa.jenis_kelamin;
                    document.getElementById('editTempatTglLahir').value = mahasiswa.tempat_tgl_lahir;
                    document.getElementById('editAgama').value = mahasiswa.agama;
                    document.getElementById('editNamaIbu').value = mahasiswa.nama_ibu;
                    document.getElementById('editNoHpOrtu').value = mahasiswa.no_hp_ortu;
                    document.getElementById('editEmailOrtu').value = mahasiswa.email_ortu;
                }
            }

            // Handle Profile Edit Form Submission
            document.getElementById('editProfileMahasiswaForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const nama = document.getElementById('editNama').value;
                const jenis_kelamin = document.getElementById('editJenisKelamin').value;
                const tempat_tgl_lahir = document.getElementById('editTempatTglLahir').value;
                const agama = document.getElementById('editAgama').value;
                const nama_ibu = document.getElementById('editNamaIbu').value;
                const no_hp_ortu = document.getElementById('editNoHpOrtu').value;
                const email_ortu = document.getElementById('editEmailOrtu').value;
                const messageDiv = document.getElementById('profileMahasiswaMessage');

                const mahasiswaIndex = mahasiswaData.findIndex(m => m.nim === loggedInNIM);
                if (mahasiswaIndex !== -1) {
                    mahasiswaData[mahasiswaIndex].nama = nama;
                    mahasiswaData[mahasiswaIndex].jenis_kelamin = jenis_kelamin;
                    mahasiswaData[mahasiswaIndex].tempat_tgl_lahir = tempat_tgl_lahir;
                    mahasiswaData[mahasiswaIndex].agama = agama;
                    mahasiswaData[mahasiswaIndex].nama_ibu = nama_ibu;
                    mahasiswaData[mahasiswaIndex].no_hp_ortu = no_hp_ortu;
                    mahasiswaData[mahasiswaIndex].email_ortu = email_ortu;

                    // Update localStorage (simulate database update)
                    localStorage.setItem('mahasiswaData', JSON.stringify(mahasiswaData));
                    localStorage.setItem('loggedInUser', nama); // Update nama di header

                    // Update displayed info
                    document.getElementById('displayNama').textContent = nama;
                    document.getElementById('displayJenisKelamin').textContent = jenis_kelamin;
                    document.getElementById('displayTempatTglLahir').textContent = tempat_tgl_lahir;
                    document.getElementById('displayAgama').textContent = agama;
                    document.getElementById('displayNamaIbu').textContent = nama_ibu;
                    document.getElementById('displayNoHpOrtu').textContent = no_hp_ortu;
                    document.getElementById('displayEmailOrtu').textContent = email_ortu;
                    document.getElementById('loggedInUserName').textContent = nama; // Update header

                    messageDiv.textContent = 'Profil berhasil diperbarui!';
                    messageDiv.style.color = 'green';
                } else {
                    messageDiv.textContent = 'Gagal memperbarui profil. Mahasiswa tidak ditemukan.';
                    messageDiv.style.color = 'red';
                }
            });

            // Handle Password Change Form Submission
            document.getElementById('changePasswordMahasiswaForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPasswordMahasiswa').value;
                const newPassword = document.getElementById('newPasswordMahasiswa').value;
                const confirmNewPassword = document.getElementById('confirmNewPasswordMahasiswa').value;
                const messageDiv = document.getElementById('passwordMahasiswaMessage');

                const mahasiswaIndex = mahasiswaData.findIndex(m => m.nim === loggedInNIM);

                if (mahasiswaIndex === -1) {
                    messageDiv.textContent = 'Pengguna tidak ditemukan.';
                    messageDiv.style.color = 'red';
                    return;
                }

                if (currentPassword !== mahasiswaData[mahasiswaIndex].password) {
                    messageDiv.textContent = 'Password saat ini salah.';
                    messageDiv.style.color = 'red';
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    messageDiv.textContent = 'Konfirmasi password baru tidak cocok.';
                    messageDiv.style.color = 'red';
                    return;
                }

                if (newPassword.length < 6) {
                    messageDiv.textContent = 'Password baru harus memiliki minimal 6 karakter.';
                    messageDiv.style.color = 'red';
                    return;
                }

                mahasiswaData[mahasiswaIndex].password = newPassword;
                localStorage.setItem('mahasiswaData', JSON.stringify(mahasiswaData)); // Update localStorage

                messageDiv.textContent = 'Password berhasil diubah!';
                messageDiv.style.color = 'green';
                document.getElementById('changePasswordMahasiswaForm').reset(); // Clear form
            });
        });
    </script>
</body>

</html>